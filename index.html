<!DOCTYPE html>
<html lang="id" class="theme-gelap accent-cyan">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edunify v6.0 - Reborn</title>
    
    <!-- Library Inti -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <!-- Library Baru untuk Panduan (Driver.js) -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- DEFINISI TEMA & PALET WARNA --- */
        :root {
            --brand-color: #0891b2; --brand-color-light: #0e7490; --brand-color-accent: #06b6d4; --brand-text: #ffffff;
            --transition-speed: 0.3s;
            --font-body: 'Inter', sans-serif;
            --font-heading: 'Poppins', sans-serif;
        }
        
        /* Accent Colors */
        .accent-cyan { --brand-color: #0891b2; --brand-color-light: #0e7490; --brand-color-accent: #06b6d4; }
        .accent-emerald { --brand-color: #059669; --brand-color-light: #047857; --brand-color-accent: #10b981; }
        .accent-indigo { --brand-color: #4f46e5; --brand-color-light: #3730a3; --brand-color-accent: #6366f1; }
        .accent-amber { --brand-color: #d97706; --brand-color-light: #b45309; --brand-color-accent: #f59e0b; }
        .accent-rose { --brand-color: #e11d48; --brand-color-light: #be123c; --brand-color-accent: #f43f5e; }
        .accent-lime { --brand-color: #65a30d; --brand-color-light: #4d7c0f; --brand-color-accent: #84cc16; }
        
        /* Base Themes */
        .theme-gelap {
            --body-bg: #0f172a; --card-bg: #1e293b; --header-bg: #0f172a80; --border-color: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --scroll-track: #1e293b; --scroll-thumb: #475569;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .theme-terang {
            --body-bg: #f1f5f9; --card-bg: #ffffff; --header-bg: #f1f5f980; --border-color: #e2e8f0; --text-primary: #1e293b; --text-secondary: #64748b; --scroll-track: #e2e8f0; --scroll-thumb: #cbd5e1; --brand-text: #ffffff;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='52' height='52' viewBox='0 0 52 52' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M10 10c0-1.105.895-2 2-2h28c1.105 0 2 .895 2 2v28c0 1.105-.895 2-2 2H12c-1.105 0-2-.895-2-2V10zm0 42c0-1.105.895-2 2-2h28c1.105 0 2 .895 2 2v-28c0 1.105-.895 2-2 2H12c-1.105 0-2-.895-2-2v28z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .theme-senja {
            --body-bg: #2d1950; --card-bg: #402b6d; --header-bg: #2d195080; --border-color: #593c93; --text-primary: #f3e8ff; --text-secondary: #d8b4fe; --scroll-track: #402b6d; --scroll-thumb: #7e57c2; --brand-text: #ffffff;
            --bg-pattern: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23a78bfa' fill-opacity='0.1' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5l-13 7.5L0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* --- GAYA DASAR & UTILITAS --- */
        body { font-family: var(--font-body); background-color: var(--body-bg); color: var(--text-primary); transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; background-image: var(--bg-pattern); }
        .font-poppins { font-family: var(--font-heading); }
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 10px; }

        /* --- GAYA KOMPONEN UI --- */
        .sidebar { background-color: color-mix(in srgb, var(--body-bg) 70%, transparent); backdrop-filter: blur(12px); border-right: 1px solid var(--border-color); }
        .header { background-color: var(--header-bg); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); }
        .brand-icon-bg { background: linear-gradient(135deg, var(--brand-color), var(--brand-color-accent)); }
        .tool-menu-item.active, .chat-history-item.active { background-color: var(--brand-color); color: var(--brand-text); box-shadow: 0 0 15px -5px var(--brand-color); }
        .tool-menu-item.active i, .chat-history-item.active i { color: var(--brand-text); }
        .tool-menu-item:not(.active) i { color: var(--brand-color-accent); }
        .tool-menu-item:not(.active):hover, .chat-history-item:not(.active):hover { background-color: color-mix(in srgb, var(--card-bg) 50%, transparent); transform: translateX(5px); }
        .tool-card { background: linear-gradient(145deg, var(--card-bg), color-mix(in srgb, var(--card-bg) 85%, #00000020)); border: 1px solid var(--border-color); border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transition: all var(--transition-speed) ease; }
        .animated-card { animation: fadeInUp 0.5s ease forwards; }
        .theme-gelap .tool-card { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 0 30px -10px var(--brand-color-accent); }
        .btn { font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.75rem; transition: all 0.2s ease; transform-origin: center; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; }
        .btn-primary { background-color: var(--brand-color); color: var(--brand-text); border-color: var(--brand-color); }
        .btn-primary:hover { background-color: var(--brand-color-light); border-color: var(--brand-color-light); box-shadow: 0 0 15px var(--brand-color); transform: translateY(-2px); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn:active { transform: scale(0.97); }
        .form-input, .form-textarea, .form-select { background-color: color-mix(in srgb, var(--body-bg) 50%, #00000010); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem; width: 100%; transition: all 0.2s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--brand-color-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand-color) 40%, transparent); }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--border-color); animation: popIn 0.3s ease-out forwards; }
        
        .chat-input-area { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: all var(--transition-speed) ease; }
        .chat-input-area:focus-within { border-color: var(--brand-color); box-shadow: 0 0 10px color-mix(in srgb, var(--brand-color) 30%, transparent); }
        .theme-selector-group { background-color: color-mix(in srgb, var(--body-bg) 50%, #00000010); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 0.75rem; }
        .theme-btn.active, .accent-btn.active, .avatar-icon-btn.active { box-shadow: 0 0 0 3px var(--brand-color); transform: scale(1.1); }

        /* --- ANIMASI & TRANSISI --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #splash-screen { animation: fadeOut 0.5s ease-in-out 2.5s forwards; }
        .loader { width: 50px; aspect-ratio: 1; border-radius: 50%; border: 8px solid; border-color: var(--brand-color) #0000; animation: l20-1 0.8s infinite linear alternate, l20-2 1.6s infinite linear; }
        @keyframes l20-1{0%{clip-path:polygon(50% 50%,0 0,50% 0,50% 0,50% 0,50% 0)}12.5%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 0,100% 0)}25%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 50%,100% 50%)}37.5%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 50%,100% 100%)}50%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 50%,50% 100%)}62.5%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 50%,0 100%)}75%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,100% 50%,0 50%)}87.5%{clip-path:polygon(50% 50%,0 0,50% 0,100% 0,0 0,0 0)}100%{clip-path:polygon(50% 50%,0 0,50% 0,50% 0,50% 0,50% 0)}}
        @keyframes l20-2{0%{transform:scaleY(1) rotate(0deg)}100%{transform:scaleY(-1) rotate(-360deg)}}
        .reveal-child { opacity: 0; animation: fadeInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .skeleton { background: linear-gradient(90deg, var(--border-color) 25%, color-mix(in srgb, var(--border-color) 50%, transparent) 50%, var(--border-color) 75%); background-size: 200% 100%; border-radius: 0.5rem; animation: shimmer 1.5s infinite; }
        .chat-message { animation: fadeInUp 0.4s ease forwards; }

        /* GAYA KONTEN MARKDOWN */
        .markdown-content h1,.markdown-content h2,.markdown-content h3{font-family: var(--font-heading);font-weight:600;margin-top:1.5rem;margin-bottom:.5rem;border-bottom:1px solid var(--border-color);padding-bottom:.25rem}
        .markdown-content code{background-color:color-mix(in srgb,var(--body-bg) 50%,#00000020);color:var(--text-primary);padding:.2rem .4rem;font-size:.9em;border-radius:.25rem}
        .markdown-content pre{background-color:color-mix(in srgb, var(--body-bg) 10%, #00000020);padding:1rem;border-radius:.5rem;overflow-x:auto;margin-bottom:1rem;position:relative;border:1px solid var(--border-color)}
        .copy-code-btn{position:absolute;top:.5rem;right:.5rem;background-color:var(--card-bg);color:var(--text-primary);border:1px solid var(--border-color);padding:.3rem .6rem;border-radius:.3rem;cursor:pointer;opacity:0;transition:opacity .2s}
        .markdown-content pre:hover .copy-code-btn{opacity:1}
        
        /* Toast Notification */
        #toast-container{position:fixed;bottom:1.5rem;right:1.5rem;z-index:10001;display:flex;flex-direction:column;gap:.75rem}
        .toast{display:flex;align-items:center;gap:1rem;padding:1rem;border-radius:.75rem;color:#fff;box-shadow:0 10px 15px -3px #0000004d,0 4px 6px -4px #0000004d;transform:translateX(calc(100% + 1.5rem));animation:slideIn .5s forwards,slideOut .5s 4.5s forwards}
        .toast.success{background:linear-gradient(to right,#059669,#10b981)}
        .toast.error{background:linear-gradient(to right,#be123c,#e11d48)}
        .toast.info{background:linear-gradient(to right,#0284c7,#0ea5e9)}
        @keyframes slideIn{from{transform:translateX(calc(100% + 1.5rem))}to{transform:translateX(0)}}
        @keyframes slideOut{from{transform:translateX(0)}to{transform:translateX(calc(100% + 1.5rem))}}
        
        /* Guide / Tutorial (Driver.js) */
        :root {
            --driver-popover-bg: var(--card-bg);
            --driver-popover-border-color: var(--border-color);
            --driver-popover-title-color: var(--text-primary);
            --driver-popover-description-color: var(--text-secondary);
            --driver-arrow-color: var(--card-bg);
            --driver-button-bg: var(--brand-color);
            --driver-button-hover-bg: var(--brand-color-light);
            --driver-button-text-color: var(--brand-text);
            --driver-button-secondary-bg: var(--border-color);
            --driver-button-secondary-hover-bg: color-mix(in srgb, var(--border-color) 80%, #fff);
            --driver-button-secondary-text-color: var(--text-primary);
        }
        .driver-popover {
            border-radius: 0.75rem;
            font-family: var(--font-body);
        }
        .driver-popover-title {
            font-family: var(--font-heading);
            font-size: 1.125rem;
        }

    </style>
</head>
<body class="font-inter bg-opacity-0">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-[#0f172a] flex flex-col items-center justify-center z-[10000]">
        <div class="flex items-center gap-4 mb-4" style="animation: popIn 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;">
            <div class="bg-cyan-500 p-3 rounded-2xl shadow-lg"><i class="fas fa-graduation-cap text-white text-4xl"></i></div>
            <h1 class="text-5xl font-extrabold font-poppins text-white tracking-tighter">Edunify <span class="text-2xl font-semibold text-cyan-400">v6.0</span></h1>
        </div>
        <p class="text-slate-400" style="animation: fadeInUp 0.5s ease-out 0.3s forwards; opacity:0;">Teman Belajar Cerdas untuk Pelajar Indonesia</p>
        <div class="absolute bottom-10 text-sm text-slate-500">Menyiapkan lingkungan belajar...</div>
    </div>
    
    <!-- Modals -->
    <div id="api-key-modal" class="modal hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="modal-content p-8 rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="text-center mb-6">
                <div class="mx-auto bg-[var(--brand-color)]/20 text-[var(--brand-color-accent)] w-16 h-16 rounded-full flex items-center justify-center mb-4 border-2 border-[var(--brand-color)]"><i class="fas fa-key text-2xl"></i></div>
                <h2 class="text-2xl font-bold font-poppins">Masukkan Kunci API Google</h2>
                <p class="text-slate-400 mt-2">Untuk memakai semua fitur AI, kamu butuh Kunci API dari Google AI Studio. Gratis kok!</p>
            </div>
            <div class="flex items-center gap-2 bg-[var(--body-bg)] border border-[var(--border-color)] rounded-xl p-1">
                <input id="api-key-input" type="password" placeholder="Tempelkan Kunci API di sini" class="flex-grow bg-transparent p-3 focus:outline-none">
                <button id="toggle-api-key-visibility" class="p-3 text-slate-400 hover:text-white"><i class="fas fa-eye"></i></button>
            </div>
            <button id="save-api-key-btn" class="w-full btn btn-primary mt-4"><i class="fas fa-save"></i>Simpan & Mulai Belajar</button>
        </div>
    </div>
    <div id="avatar-modal" class="modal hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="modal-content p-8 rounded-2xl shadow-2xl max-w-lg w-full">
            <h2 class="text-2xl font-bold font-poppins text-center mb-6">Kustomisasi Avatar</h2>
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-3 text-center">Pilih Ikon</h3>
                <div id="avatar-icon-grid" class="grid grid-cols-6 gap-3"></div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-3 text-center">Pilih Warna Latar</h3>
                <div id="avatar-color-grid" class="grid grid-cols-6 gap-3"></div>
            </div>
            <button id="close-avatar-modal-btn" class="w-full btn btn-secondary mt-8">Tutup</button>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app" class="flex h-screen overflow-hidden opacity-0 transition-opacity duration-500">
        <aside id="left-sidebar" class="sidebar w-72 md:w-80 p-4 flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0 fixed md:relative h-full z-40">
            <div class="flex items-center justify-between gap-3 mb-4 px-2 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="brand-icon-bg p-2.5 rounded-lg shadow-lg"><i class="fas fa-graduation-cap text-white text-xl"></i></div>
                    <h1 class="text-2xl font-bold font-poppins">Edunify</h1>
                </div>
            </div>
            <div class="relative mb-2 px-2 shrink-0">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="tool-search-input" type="text" placeholder="Cari tool..." class="form-input w-full pl-10 !rounded-full">
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2 -mr-2">
                <div id="chat-history-container" class="mb-4"></div>
                <nav id="tools-menu" class="space-y-1"></nav>
            </div>

            <div class="mt-4 pt-4 border-t border-[var(--border-color)] shrink-0 space-y-3">
                 <div>
                    <div class="text-sm font-semibold text-[var(--text-secondary)] mb-2 px-2">Tampilan & Warna</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div id="theme-mode-selector" class="theme-selector-group grid grid-cols-3 gap-1 !p-1">
                            <button data-theme="theme-terang" title="Terang" class="theme-btn h-8 w-full rounded-md flex items-center justify-center gap-1 text-sm bg-slate-200 text-slate-600"><i class="fas fa-sun"></i></button>
                            <button data-theme="theme-senja" title="Senja" class="theme-btn h-8 w-full rounded-md flex items-center justify-center gap-1 text-sm bg-[#402b6d] text-purple-300"><i class="fas fa-moon"></i></button>
                            <button data-theme="theme-gelap" title="Gelap" class="theme-btn h-8 w-full rounded-md flex items-center justify-center gap-1 text-sm bg-slate-800 text-slate-300"><i class="fas fa-star"></i></button>
                        </div>
                        <div id="accent-color-selector" class="theme-selector-group grid grid-cols-6 gap-1 !p-1">
                            <button data-accent="accent-cyan" title="Cyan" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #0891b2;"></button>
                            <button data-accent="accent-emerald" title="Emerald" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #059669;"></button>
                            <button data-accent="accent-indigo" title="Indigo" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #4f46e5;"></button>
                            <button data-accent="accent-amber" title="Amber" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #d97706;"></button>
                            <button data-accent="accent-rose" title="Rose" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #e11d48;"></button>
                             <button data-accent="accent-lime" title="Lime" class="accent-btn h-8 w-full rounded-full transition-all" style="background-color: #65a30d;"></button>
                        </div>
                    </div>
                </div>
                <div id="user-profile" class="flex items-center gap-3 p-2 rounded-lg hover:bg-[var(--card-bg)] cursor-pointer transition-colors">
                    <div id="user-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xl flex-shrink-0 transition-colors">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="font-semibold">Pelajar Hebat</div>
                        <div class="text-xs text-[var(--text-secondary)]">Ubah Avatar</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content flex-1 flex flex-col overflow-hidden">
            <header class="header flex items-center justify-between p-4 z-10 shrink-0">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-bars text-xl"></i></button>
                    <h2 id="tool-title" class="text-lg font-semibold">AI Chat Assistant</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="help-btn" class="btn btn-secondary !p-2 !rounded-lg" title="Bantuan & Panduan"><i class="fas fa-question-circle"></i></button>
                    <button id="fullscreen-btn" class="btn btn-secondary !p-2 !rounded-lg" title="Layar Penuh"><i class="fas fa-expand"></i></button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 relative"></div>
        </main>
    </div>
    
    <div id="toast-container"></div>

    <!-- TEMPLATES -->
    <template id="ai-chat-view-template">
        <div class="tool-view h-full flex flex-col">
            <div class="chat-container flex-grow space-y-6 overflow-y-auto pr-4 -mr-4 mb-4"></div>
            <div class="mt-auto shrink-0">
                <div class="chat-input-area p-2 rounded-2xl relative">
                     <div class="relative flex items-end gap-2">
                        <textarea class="chat-input form-textarea w-full p-3 pr-14 resize-none bg-transparent border-0 focus:ring-0" rows="1" placeholder="Tanya apa saja ke Edunify..."></textarea>
                        <button class="send-chat-btn absolute right-3 bottom-3 bg-[var(--brand-color)] hover:bg-[var(--brand-color-light)] text-white font-bold w-10 h-10 rounded-xl transition-all transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="generic-tool-view-template">
        <div class="max-w-4xl mx-auto tool-card space-y-6">
            <div class="flex items-center gap-4 text-2xl font-bold font-poppins border-b border-[var(--border-color)] pb-4 mb-2"><i class="tool-icon fas fa-cogs text-[var(--brand-color-accent)]"></i><span class="tool-name">Generic Tool</span></div>
            <div class="relative">
                <textarea class="generic-input form-textarea" rows="8"></textarea>
                <button class="generic-clear-btn absolute top-3 right-3 text-[var(--text-secondary)] hover:text-[var(--text-primary)]" title="Hapus Input"><i class="fas fa-times"></i></button>
            </div>
            <button class="generic-submit-btn w-full btn btn-primary"><i class="fas fa-cogs"></i>Proses dengan AI</button>
            <div class="pt-6 border-t border-[var(--border-color)]">
                <h4 class="font-semibold text-[var(--text-secondary)] mb-2">Hasil AI:</h4>
                <div class="generic-output min-h-[100px]">
                    <div class="space-y-3 loading-skeleton hidden">
                        <div class="skeleton h-4 w-3/4"></div><div class="skeleton h-4 w-full"></div><div class="skeleton h-4 w-5/6"></div>
                    </div>
                    <div class="markdown-content result-container"><p class="text-[var(--text-secondary)]">Hasil keren dari AI akan muncul di sini!</p></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === CONFIG & STATE v6.0 ===
            const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=';
            const appState = {
                apiKey: localStorage.getItem('edunify_api_key_v2') || null,
                currentToolId: 'ai-chat',
                isGenerating: false,
                chatSessions: JSON.parse(localStorage.getItem('edunify_chat_sessions_v4')) || {},
                currentChatSessionId: null,
                userAvatar: JSON.parse(localStorage.getItem('edunify_user_avatar_v2')) || { icon: 'fa-user-graduate', color: '#0891b2' },
                guideCompleted: localStorage.getItem('edunify_guide_completed_v2') || false,
            };
            const markdownConverter = new showdown.Converter({tables: true, strikethrough: true, simplifiedAutoLink: true, tasklists: true, openLinksInNewWindow: true});
            
            // --- DATABASE ALAT v6.0 (25+ Tools) ---
            const tools = [
                // Kategori: Utama
                { id: 'ai-chat', name: 'AI Chat Assistant', icon: 'fa-comments', category: 'Utama', sys_prompt: 'Anda adalah Edunify, asisten AI yang ceria, ramah, dan suportif untuk pelajar Indonesia (SD, SMP, SMA). Jawablah pertanyaan dengan jelas, informatif, dan mudah dimengerti. Gunakan sapaan seperti "kamu" dan berikan semangat!', type: 'chat' },
                { id: 'summarizer', name: 'Pembuat Ringkasan', icon: 'fa-file-zipper', category: 'Utama', sys_prompt: 'Anda adalah ahli dalam meringkas teks. Buat ringkasan yang padat, jelas, dan akurat dari teks yang diberikan. Gunakan poin-poin atau paragraf singkat.', placeholder: 'Tempelkan teks atau artikel panjang di sini...' },
                { id: 'translator', name: 'Penerjemah Bahasa', icon: 'fa-language', category: 'Utama', sys_prompt: 'Anda adalah penerjemah ahli. Terjemahkan teks yang diberikan ke dalam bahasa yang diminta secara akurat dengan tetap menjaga nuansa dan konteksnya.', placeholder: 'Contoh: "Hello world to Indonesian"' },
                { id: 'paraphraser', name: 'Parafrase Kalimat', icon: 'fa-pen-nib', category: 'Utama', sys_prompt: 'Anda adalah ahli parafrase. Tulis ulang teks yang diberikan dengan gaya bahasa yang berbeda namun tetap mempertahankan makna aslinya. Berikan 3 opsi tulisan ulang.', placeholder: 'Tempelkan kalimat atau paragraf yang ingin ditulis ulang...' },
                { id: 'spell-checker', name: 'Koreksi Ejaan & Tata Bahasa', icon: 'fa-spell-check', category: 'Utama', sys_prompt: 'Anda adalah editor ahli. Periksa teks, perbaiki kesalahan ejaan & tata bahasa, lalu berikan versi yang sudah benar dan bersih. Jelaskan juga perbaikannya secara singkat.', placeholder: 'Tempelkan tulisanmu di sini untuk diperiksa...' },
                
                // Kategori: Akademik
                { id: 'math-solver', name: 'Pemecah Soal Matematika', icon: 'fa-calculator', category: 'Akademik', sys_prompt: 'Anda adalah guru matematika yang sabar. Pecahkan soal matematika yang diberikan dan jelaskan setiap langkahnya secara rinci dan mudah diikuti.', placeholder: 'Contoh: Tentukan akar dari x^2 - 5x + 6 = 0' },
                { id: 'essay-writer', name: 'Asisten Penulis Esai', icon: 'fa-file-word', category: 'Akademik', sys_prompt: 'Anda adalah asisten penulis esai. Buatkan kerangka (outline) dan draf awal esai berdasarkan topik dan jumlah paragraf yang diminta pengguna. Gunakan struktur pendahuluan, isi, dan penutup.', placeholder: 'Topik: Dampak positif dan negatif internet bagi pelajar. Jumlah paragraf: 5' },
                { id: 'practice-problems', name: 'Generator Latihan Soal', icon: 'fa-pencil-ruler', category: 'Akademik', sys_prompt: 'Anda adalah guru yang membuat soal. Buatkan 5 soal latihan (bisa esai atau pilihan ganda) berdasarkan topik dan tingkat kesulitan yang diberikan pengguna. Sertakan juga kunci jawabannya di bagian akhir.', placeholder: 'Buatkan soal tentang "Fotosintesis" untuk kelas 5 SD.'},
                { id: 'concept-simplifier', name: 'Penyederhana Konsep', icon: 'fa-lightbulb', category: 'Akademik', sys_prompt: 'Jelaskan konsep sulit yang diberikan pengguna menggunakan analogi dan bahasa yang sangat sederhana, seolah-olah menjelaskan kepada anak kelas 5 SD.', placeholder: 'Jelaskan apa itu "Lubang Hitam" (Black Hole)?' },
                { id: 'science-project-ideas', name: 'Ide Proyek Ilmiah', icon: 'fa-flask-vial', category: 'Akademik', sys_prompt: 'Anda adalah seorang ilmuwan kreatif. Berikan 5 ide proyek ilmiah yang menarik dan bisa dilakukan oleh pelajar (SD/SMP/SMA) berdasarkan topik yang diberikan. Sertakan tujuan, bahan, dan langkah singkatnya.', placeholder: 'Topik: Energi alternatif untuk anak SMP' },
                { id: 'history-explainer', name: 'Penjelas Sejarah', icon: 'fa-landmark', category: 'Akademik', sys_prompt: `Jelaskan peristiwa atau tokoh sejarah yang ditanyakan pengguna secara ringkas dan menarik. Fokus pada "mengapa" peristiwa itu penting.`, placeholder: 'Ceritakan tentang Perang Diponegoro.'},
                { id: 'pro-con-list', name: 'Daftar Pro & Kontra', icon: 'fa-scale-balanced', category: 'Akademik', sys_prompt: 'Buat daftar poin-poin argumen Pro dan Kontra dalam format tabel markdown untuk topik yang diberikan. Berikan masing-masing 3-5 poin yang seimbang.', placeholder: 'Pro dan kontra "Siswa membawa HP ke sekolah".' },

                // Kategori: Kreatif
                { id: 'story-generator', name: 'Generator Cerita', icon: 'fa-feather-alt', category: 'Kreatif', sys_prompt: 'Tulis cerita pendek yang menarik berdasarkan ide yang diberikan. Kembangkan karakter, plot, dan latar yang imajinatif.', placeholder: 'Ide cerita: "Seorang anak menemukan pensil ajaib yang bisa menghidupkan gambar."' },
                { id: 'poem-analysis', name: 'Analisis Puisi', icon: 'fa-book-open-reader', category: 'Kreatif', sys_prompt: 'Anda adalah seorang sastrawan. Analisis puisi yang diberikan, jelaskan makna, majas/gaya bahasa, dan suasana yang dibangun dalam puisi tersebut.', placeholder: 'Tempelkan puisi di sini untuk dianalisis...' },
                { id: 'proverb-explainer', name: 'Arti Peribahasa', icon: 'fa-comment-dots', category: 'Kreatif', sys_prompt: 'Jelaskan arti dari peribahasa Indonesia yang diberikan, dan berikan contoh penggunaannya dalam sebuah kalimat.', placeholder: 'Apa arti dari "Air beriak tanda tak dalam"?' },
                { id: 'book-recommender', name: 'Rekomendasi Buku', icon: 'fa-book-sparkles', category: 'Kreatif', sys_prompt: 'Anda adalah seorang pustakawan yang bersemangat. Berikan 3 rekomendasi buku (fiksi atau non-fiksi) berdasarkan genre atau topik yang disukai pengguna. Sertakan sinopsis singkat untuk setiap buku.', placeholder: 'Rekomendasi buku fantasi untuk remaja.' },
                { id: 'poem-generator', name: 'Pembuat Puisi', icon: 'fa-pen-fancy', category: 'Kreatif', sys_prompt: 'Buat sebuah puisi pendek (2-3 bait) berdasarkan tema atau kata kunci yang diberikan. Perhatikan rima dan diksi agar terdengar indah.', placeholder: 'Buatkan puisi tentang "hujan di sore hari".' },
                { id: 'name-ideas', name: 'Generator Ide Nama', icon: 'fa-lightbulb-on', category: 'Kreatif', sys_prompt: 'Berikan 10 ide nama yang kreatif dan unik untuk keperluan yang disebutkan pengguna (misal: nama grup belajar, nama channel, judul cerita).', placeholder: 'Ide nama untuk grup belajar IPA.' },
                { id: 'joke-generator', name: 'Pembuat Lelucon', icon: 'fa-laugh-beam', category: 'Kreatif', sys_prompt: 'Berikan 3 lelucon singkat atau tebak-tebakan lucu yang cocok untuk anak sekolah tentang topik yang diberikan.', placeholder: 'Beri aku lelucon tentang: "matematika"' },

                // Kategori: Produktivitas
                { id: 'study-plan-maker', name: 'Perencana Belajar', icon: 'fa-calendar-check', category: 'Produktivitas', sys_prompt: 'Buatkan draf rencana belajar mingguan dalam format tabel markdown berdasarkan mata pelajaran dan target yang diberikan pengguna.', placeholder: 'Buatkan rencana belajar untuk Ujian Akhir Semester. Mapel: Matematika, IPA, B. Indonesia. Target: Belajar 2 jam setiap hari.' },
                { id: 'email-writer', name: 'Asisten Email', icon: 'fa-envelope-open-text', category: 'Produktivitas', sys_prompt: 'Anda adalah asisten profesional untuk menulis email. Buat draf email yang jelas, ringkas, dan sopan berdasarkan permintaan pengguna. Sesuaikan nadanya (formal, informal, dll.) sesuai kebutuhan.', placeholder: 'Tulis email ke guru untuk meminta izin tidak masuk sekolah karena sakit.'},
                { id: 'code-assistant', name: 'Asisten Kode', icon: 'fa-code', category: 'Produktivitas', sys_prompt: 'Anda adalah asisten kode ahli. Bantu pengguna menulis, men-debug, dan menjelaskan kode dalam berbagai bahasa pemrograman. Berikan penjelasan yang jelas dan format blok kode dengan benar.', placeholder: 'Buat fungsi python untuk mengecek apakah sebuah kata adalah palindrom.'},
                { id: 'acronym-generator', name: 'Jembatan Keledai', icon: 'fa-road', category: 'Produktivitas', sys_prompt: 'Buat jembatan keledai (akronim atau kalimat lucu) untuk membantu mengingat daftar atau urutan yang diberikan.', placeholder: 'Bantu aku mengingat urutan planet: Merkurius, Venus, Bumi...' },
                { id: 'recipe-generator', name: 'Generator Resep Cepat', icon: 'fa-utensils', category: 'Produktivitas', sys_prompt: 'Anda adalah seorang koki kreatif. Hasilkan resep sederhana dan cepat (untuk anak kos/pelajar) berdasarkan bahan yang diberikan oleh pengguna. Sebutkan bahan-bahannya dan berikan petunjuk langkah demi langkah.', placeholder: 'Beri aku resep menggunakan: nasi, telur, dan kecap.' },
            ];
            
            const DOMElements = {
                html: document.documentElement, app: document.getElementById('app'),
                apiKeyModal: document.getElementById('api-key-modal'), apiKeyInput: document.getElementById('api-key-input'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'), toggleApiKeyVisibility: document.getElementById('toggle-api-key-visibility'),
                avatarModal: document.getElementById('avatar-modal'), closeAvatarModalBtn: document.getElementById('close-avatar-modal-btn'),
                avatarIconGrid: document.getElementById('avatar-icon-grid'), avatarColorGrid: document.getElementById('avatar-color-grid'),
                userProfile: document.getElementById('user-profile'), userAvatar: document.getElementById('user-avatar'),
                menu: document.getElementById('tools-menu'), toolTitle: document.getElementById('tool-title'),
                contentArea: document.getElementById('content-area'), menuToggle: document.getElementById('menu-toggle'),
                leftSidebar: document.getElementById('left-sidebar'), themeModeSelector: document.getElementById('theme-mode-selector'),
                accentColorSelector: document.getElementById('accent-color-selector'), toastContainer: document.getElementById('toast-container'),
                toolSearchInput: document.getElementById('tool-search-input'), fullscreenBtn: document.getElementById('fullscreen-btn'),
                helpBtn: document.getElementById('help-btn'), chatHistoryContainer: document.getElementById('chat-history-container'),
                templates: { chat: document.getElementById('ai-chat-view-template'), generic: document.getElementById('generic-tool-view-template') }
            };

            // --- INIT FUNCTION (STABILITY GUARANTEED) ---
            function init() {
                // Phase 1: Setup all data and initial state from localStorage
                setupTheming();
                setupAvatar();
                manageChatSessions(); // This determines the initial chat session and tool

                // Phase 2: Render all UI components based on the initial state
                renderMenu();
                renderChatHistory();
                selectTool(appState.currentToolId, appState.currentToolId === 'ai-chat', false); // Render the initial view without animation
                
                // Phase 3: Attach all event listeners
                setupEventListeners();

                // Phase 4: Hide splash, show app, and then conditionally start the guide
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                    
                    if (!appState.apiKey) {
                        showModal(DOMElements.apiKeyModal);
                    } else {
                        DOMElements.app.style.opacity = '1';
                        if (!appState.guideCompleted) {
                            // Use another timeout to ensure the app is fully painted before starting the guide
                            setTimeout(() => startGuide(), 500);
                        }
                    }
                }, 2500);
            }

            async function callGeminiAPI(prompt, systemInstruction) {
                if (!appState.apiKey) { showToast('error', 'Kunci API belum dimasukkan.'); return null; }
                appState.isGenerating = true; updateSendButtonsState();
                try {
                    const history = (appState.currentToolId === 'ai-chat' && appState.currentChatSessionId) ? appState.chatSessions[appState.currentChatSessionId].history : [];
                    const contents = [...history, { role: 'user', parts: [{ text: prompt }] }];
                    const response = await fetch(API_URL + appState.apiKey, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: systemInstruction }] } })
                    });
                    if (!response.ok) { const error = await response.json(); throw new Error(error.error ? error.error.message : 'Unknown API Error'); }
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) { showToast('error', `Error API: ${error.message}`); return null; } 
                finally { appState.isGenerating = false; updateSendButtonsState(); }
            }
            
            function renderMenu(filter = '') {
                const categories = {'Utama': 'fa-star', 'Akademik': 'fa-university', 'Kreatif': 'fa-palette', 'Produktivitas': 'fa-bolt'};
                const filteredTools = tools.filter(t => t.id !== 'ai-chat' && t.name.toLowerCase().includes(filter.toLowerCase()));
                DOMElements.menu.innerHTML = Object.keys(categories).map(category => {
                    const toolsInCategory = filteredTools.filter(t => t.category === category);
                    if (toolsInCategory.length === 0) return '';
                    return `<h3 class="flex items-center gap-2 px-2 pt-4 pb-1 text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider"><i class="fas ${categories[category]}"></i>${category}</h3>
                        ${toolsInCategory.map((tool, index) => `<button data-tool-id="${tool.id}" title="${tool.name}" class="tool-menu-item w-full flex items-center gap-4 p-2.5 rounded-lg transition-all text-left reveal-child" style="animation-delay:${index*30}ms"><i class="fas ${tool.icon} w-6 text-center text-xl"></i><span class="font-semibold text-sm">${tool.name}</span></button>`).join('')}`;
                }).join('');
                const activeItem = DOMElements.menu.querySelector(`[data-tool-id="${appState.currentToolId}"]`);
                if (activeItem) activeItem.classList.add('active');
            }

            function selectTool(toolId, isChatSession = false, animate = true) {
                if (!isChatSession) {
                    appState.currentChatSessionId = null;
                }
                appState.currentToolId = toolId;
                const tool = tools.find(t => t.id === toolId);
                DOMElements.toolTitle.textContent = tool.name;

                document.querySelectorAll('.tool-menu-item, .chat-history-item').forEach(item=>item.classList.remove('active'));
                const activeTool = DOMElements.menu.querySelector(`[data-tool-id="${toolId}"]`);
                if (activeTool) activeTool.classList.add('active');
                const activeChat = DOMElements.chatHistoryContainer.querySelector(`[data-session-id="${appState.currentChatSessionId}"]`);
                if (activeChat) activeChat.classList.add('active');
                
                DOMElements.contentArea.innerHTML = '';
                
                switch(tool.type) {
                    case 'chat': renderChatView(animate); break;
                    default: renderGenericToolView(tool, animate); break;
                }
                if (window.innerWidth < 768) DOMElements.leftSidebar.classList.add('-translate-x-full');
            }

            function addCodeCopyButtons() {
                document.querySelectorAll('.markdown-content pre').forEach(pre => {
                    if (pre.querySelector('.copy-code-btn')) return;
                    const button = document.createElement('button');
                    button.innerHTML = '<i class="fas fa-copy"></i> Salin';
                    button.className = 'copy-code-btn text-xs';
                    button.onclick = () => {
                        const code = pre.querySelector('code').innerText;
                        navigator.clipboard.writeText(code);
                        button.innerHTML = '<i class="fas fa-check"></i> Disalin!';
                        showToast('success', 'Kode disalin ke clipboard.');
                        setTimeout(() => button.innerHTML = '<i class="fas fa-copy"></i> Salin', 2000);
                    };
                    pre.appendChild(button);
                });
            }

            function setupTheming() {
                const savedTheme = localStorage.getItem('edunify_theme_mode_v2') || 'theme-gelap';
                const savedAccent = localStorage.getItem('edunify_accent_color_v2') || 'accent-cyan';
                setThemeMode(savedTheme);
                setAccentColor(savedAccent);
            }
            function setThemeMode(themeClass) {
                DOMElements.html.classList.remove('theme-gelap', 'theme-terang', 'theme-senja');
                DOMElements.html.classList.add(themeClass);
                localStorage.setItem('edunify_theme_mode_v2', themeClass);
                DOMElements.themeModeSelector.querySelectorAll('.theme-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.theme === themeClass));
            }
            function setAccentColor(accentClass) {
                 DOMElements.html.className = DOMElements.html.className.replace(/accent-\w+/g, '');
                 DOMElements.html.classList.add(accentClass);
                 localStorage.setItem('edunify_accent_color_v2', accentClass);
                 DOMElements.accentColorSelector.querySelectorAll('.accent-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.accent === accentClass));
            }
            
            function setupAvatar() {
                const icons = ['fa-user-graduate', 'fa-user-astronaut', 'fa-user-ninja', 'fa-cat', 'fa-dog', 'fa-dragon', 'fa-hippo', 'fa-kiwi-bird', 'fa-otter', 'fa-spider', 'fa-ghost', 'fa-robot'];
                const colors = ['#0891b2', '#059669', '#4f46e5', '#d97706', '#e11d48', '#65a30d', '#6d28d9', '#db2777'];
                
                DOMElements.avatarIconGrid.innerHTML = icons.map(icon => `<button class="avatar-icon-btn h-12 w-full rounded-lg transition-all flex items-center justify-center text-2xl bg-[var(--border-color)]" data-icon="${icon}"><i class="fas ${icon}"></i></button>`).join('');
                DOMElements.avatarColorGrid.innerHTML = colors.map(color => `<button class="avatar-color-btn h-12 w-full rounded-lg transition-all" data-color="${color}" style="background-color: ${color};"></button>`).join('');

                updateAvatarDisplay();

                DOMElements.avatarIconGrid.addEventListener('click', e => {
                    const btn = e.target.closest('.avatar-icon-btn');
                    if (!btn) return;
                    appState.userAvatar.icon = btn.dataset.icon;
                    saveAvatar();
                });
                DOMElements.avatarColorGrid.addEventListener('click', e => {
                    const btn = e.target.closest('.avatar-color-btn');
                    if (!btn) return;
                    appState.userAvatar.color = btn.dataset.color;
                    saveAvatar();
                });
            }
            function saveAvatar() {
                localStorage.setItem('edunify_user_avatar_v2', JSON.stringify(appState.userAvatar));
                updateAvatarDisplay();
            }
            function updateAvatarDisplay() {
                const { icon, color } = appState.userAvatar;
                DOMElements.userAvatar.style.backgroundColor = color;
                DOMElements.userAvatar.querySelector('i').className = `fas ${icon}`;
                DOMElements.avatarIconGrid.querySelectorAll('.avatar-icon-btn').forEach(b => b.classList.toggle('active', b.dataset.icon === icon));
                DOMElements.avatarColorGrid.querySelectorAll('.avatar-color-btn').forEach(b => b.classList.toggle('active', b.dataset.color === color));
            }
            
            function manageChatSessions() {
                if (Object.keys(appState.chatSessions).length === 0) {
                    startNewChat(false); // don't select it, just create
                }
                const sessionKeys = Object.keys(appState.chatSessions);
                appState.currentChatSessionId = sessionKeys[sessionKeys.length - 1]; // open latest chat
                appState.currentToolId = 'ai-chat';
            }

            function renderChatHistory() {
                const sessionKeys = Object.keys(appState.chatSessions);
                if (sessionKeys.length === 0) {
                    DOMElements.chatHistoryContainer.innerHTML = ''; return;
                }
                DOMElements.chatHistoryContainer.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="flex items-center gap-2 px-2 pt-4 pb-1 text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider"><i class="fas fa-history"></i>Riwayat Chat</h3>
                        <button id="new-chat-btn" title="Mulai Chat Baru" class="btn btn-secondary !p-1.5 !text-xs !rounded-md"><i class="fas fa-plus"></i> Baru</button>
                    </div>
                    ${sessionKeys.reverse().map(id => {
                        const session = appState.chatSessions[id];
                        const title = session.history.length > 0 ? session.history[0].parts[0].text : 'Chat Kosong';
                        return `<button data-session-id="${id}" class="chat-history-item w-full flex items-center gap-4 p-2.5 rounded-lg transition-all text-left">
                            <i class="fas fa-comment w-6 text-center text-sm text-[var(--text-secondary)]"></i>
                            <span class="font-semibold text-sm truncate">${title}</span>
                        </button>`;
                    }).join('')}
                `;
                document.getElementById('new-chat-btn').onclick = () => startNewChat(true);
            }

            function startNewChat(selectAfter = true) {
                const newId = `chat_${Date.now()}`;
                appState.chatSessions[newId] = { history: [] };
                saveChatHistory();
                renderChatHistory();
                if (selectAfter) {
                    appState.currentChatSessionId = newId;
                    selectTool('ai-chat', true);
                    showToast('info', 'Chat baru dimulai!');
                }
            }

            function renderChatView(animate = true) {
                const view = DOMElements.templates.chat.content.cloneNode(true);
                const toolView = view.querySelector('.tool-view');
                if (toolView && !animate) toolView.style.animation = 'none';
                
                DOMElements.contentArea.appendChild(view);
                
                const input = DOMElements.contentArea.querySelector('.chat-input');
                const sendBtn = DOMElements.contentArea.querySelector('.send-chat-btn');
                
                sendBtn.onclick = handleChatSubmit;
                input.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatSubmit(); }});
                input.addEventListener('input', () => { input.style.height = 'auto'; input.style.height = `${Math.min(input.scrollHeight, 200)}px`; });
                
                const currentHistory = appState.currentChatSessionId ? appState.chatSessions[appState.currentChatSessionId].history : [];
                if (currentHistory && currentHistory.length > 0) {
                    currentHistory.forEach(msg => {
                        if (msg.role === 'user') addUserMessage(msg.parts[0].text, false);
                        else addBotMessage(msg.parts[0].text, false, false);
                    });
                } else {
                    addBotMessage("Halo! Aku Edunify v6.0. Siap membantumu belajar. Mau tanya apa hari ini?", false, false);
                }
            }

            async function handleChatSubmit() {
                if(appState.isGenerating || !appState.currentChatSessionId) return;
                const input = DOMElements.contentArea.querySelector('.chat-input');
                const message = input.value.trim();
                if(!message) return;
                
                addUserMessage(message);
                input.value = ''; input.style.height='auto';
                
                const loadingEl = addBotMessage('<div class="loader"></div>', true, false);
                const tool=tools.find(t=>t.id==='ai-chat');
                const response = await callGeminiAPI(message, tool.sys_prompt);
                
                loadingEl.remove();
                if(response){
                    addBotMessage(response, false, true);
                } else {
                    addBotMessage("Maaf, sepertinya ada sedikit gangguan. Coba lagi ya!", false, false);
                }
            }

            function saveChatHistory() {
                localStorage.setItem('edunify_chat_sessions_v4', JSON.stringify(appState.chatSessions));
            }

            function addUserMessage(message, shouldSave=true){
                if(shouldSave && appState.currentChatSessionId) {
                    appState.chatSessions[appState.currentChatSessionId].history.push({role: 'user', parts: [{ text: message }] });
                    saveChatHistory();
                    if(appState.chatSessions[appState.currentChatSessionId].history.length === 1) renderChatHistory(); // update title
                }
                const container = DOMElements.contentArea.querySelector('.chat-container');
                const el = document.createElement('div');
                el.className = 'chat-message flex items-start gap-4 justify-end';
                el.innerHTML = `<div class="bg-[var(--brand-color)] text-[var(--brand-text)] p-4 rounded-2xl rounded-br-none max-w-2xl shadow-lg markdown-content">${markdownConverter.makeHtml(message)}</div><div style="background-color:${appState.userAvatar.color}" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xl flex-shrink-0"><i class="fas ${appState.userAvatar.icon}"></i></div>`;
                container.appendChild(el);
                container.scrollTop = container.scrollHeight;
            }

            function addBotMessage(message, isRawHtml = false, shouldSave = true) {
                if(shouldSave && appState.currentChatSessionId) {
                    appState.chatSessions[appState.currentChatSessionId].history.push({role: 'model', parts: [{ text: message }] });
                    saveChatHistory();
                }
                const container = DOMElements.contentArea.querySelector('.chat-container');
                const el = document.createElement('div');
                el.className = 'chat-message flex items-start gap-4 bot-message';
                const content = isRawHtml ? message : markdownConverter.makeHtml(message);
                el.innerHTML = `<div class="brand-icon-bg rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center border-2 border-color-mix(in srgb, var(--brand-color-accent) 50%, #ffffff50)"><i class="fas fa-graduation-cap"></i></div><div class="bg-[var(--card-bg)] p-4 rounded-2xl rounded-tl-none max-w-2xl shadow-lg markdown-content message-content w-full">${content}</div>`;
                container.appendChild(el);
                container.scrollTop = container.scrollHeight;
                addCodeCopyButtons();
                return el;
            }
            
            function renderGenericToolView(tool, animate = true) {
                const view = DOMElements.templates.generic.content.cloneNode(true);
                const toolCard = view.querySelector('.tool-card');
                if (toolCard) {
                    toolCard.classList.toggle('animated-card', animate);
                }
                view.querySelector('.tool-icon').className = `tool-icon fas ${tool.icon} text-[var(--brand-color-accent)]`;
                view.querySelector('.tool-name').textContent = tool.name;
                const input = view.querySelector('.generic-input');
                input.placeholder = tool.placeholder;
                view.querySelector('.generic-submit-btn').onclick = () => handleGenericToolSubmit(tool);
                view.querySelector('.generic-clear-btn').onclick = () => input.value = '';
                DOMElements.contentArea.appendChild(view);
            }
            async function handleGenericToolSubmit(tool) {
                if(appState.isGenerating)return;
                const view = DOMElements.contentArea.querySelector('.tool-card');
                const resultEl = view.querySelector('.result-container');
                const prompt = view.querySelector('.generic-input').value.trim();
                if(!prompt && tool.id !== 'history-today'){resultEl.innerHTML='<p class="text-red-400">Input tidak boleh kosong.</p>';return}
                view.querySelector('.loading-skeleton').classList.remove('hidden'); resultEl.classList.add('hidden');
                const response = await callGeminiAPI(prompt, tool.sys_prompt);
                view.querySelector('.loading-skeleton').classList.add('hidden'); resultEl.classList.remove('hidden');
                if(response){ resultEl.innerHTML = markdownConverter.makeHtml(response); addCodeCopyButtons(); }
                else { resultEl.innerHTML='<p class="text-red-400">Gagal mendapatkan respons dari AI.</p>'; }
            }

            function setupEventListeners() {
                DOMElements.saveApiKeyBtn.onclick = () => {
                    const key = DOMElements.apiKeyInput.value.trim();
                    if(key){
                        appState.apiKey = key;
                        localStorage.setItem('edunify_api_key_v2', key);
                        hideModal(DOMElements.apiKeyModal);
                        DOMElements.app.style.opacity = '1';
                        showToast('success', 'Kunci API berhasil disimpan.');
                        if (!appState.guideCompleted) setTimeout(() => startGuide(), 500);
                    }
                };
                DOMElements.toggleApiKeyVisibility.onclick=()=>{const i=DOMElements.apiKeyInput,c=DOMElements.toggleApiKeyVisibility.querySelector('i');i.type=i.type==='password'?'text':'password';c.className=`fas fa-eye${i.type==='password'?'':'-slash'}`};
                DOMElements.menu.addEventListener('click', e => { const btn = e.target.closest('.tool-menu-item'); if (btn) selectTool(btn.dataset.toolId); });
                DOMElements.chatHistoryContainer.addEventListener('click', e => { const btn = e.target.closest('.chat-history-item'); if(btn){ appState.currentChatSessionId = btn.dataset.sessionId; selectTool('ai-chat', true); }});
                DOMElements.themeModeSelector.addEventListener('click', e => { const btn = e.target.closest('.theme-btn'); if(btn) setThemeMode(btn.dataset.theme); });
                DOMElements.accentColorSelector.addEventListener('click', e => { const btn = e.target.closest('.accent-btn'); if(btn) setAccentColor(btn.dataset.accent); });
                DOMElements.menuToggle.onclick=()=>DOMElements.leftSidebar.classList.toggle('-translate-x-full');
                DOMElements.toolSearchInput.addEventListener('input', e => renderMenu(e.target.value));
                DOMElements.fullscreenBtn.onclick = toggleFullScreen;
                DOMElements.userProfile.onclick = () => showModal(DOMElements.avatarModal);
                DOMElements.closeAvatarModalBtn.onclick = () => hideModal(DOMElements.avatarModal);
                DOMElements.helpBtn.onclick = startGuide;
            }
            
            // --- Guide / Tutorial Functions (Driver.js) ---
            function startGuide() {
                const driver = window.driver.driver;
                const driverObj = driver({
                    showProgress: true,
                    steps: [
                        { element: '#chat-history-container', popover: { title: 'Riwayat Chat', description: 'Semua percakapanmu dengan AI Chat akan tersimpan di sini. Kamu bisa membukanya lagi kapan saja.' } },
                        { element: '#tools-menu', popover: { title: 'Daftar Tools', description: 'Temukan semua alat AI keren untuk membantumu belajar, mulai dari menjawab soal sampai membuat cerita.' } },
                        { element: '#content-area', popover: { title: 'Area Konten', description: 'Di sinilah semua keajaiban terjadi! Baik itu chat atau hasil dari tool lain, semuanya akan muncul di sini.' } },
                        { element: '#user-profile', popover: { title: 'Profil Kamu', description: 'Klik di sini untuk mengubah ikon dan warna avatarmu agar lebih personal!', side: "top", align: 'start' } },
                        { element: '#theme-mode-selector', popover: { title: 'Ganti Tampilan', description: 'Bosan dengan tampilan? Kamu bisa ganti tema terang, senja, atau gelap di sini.', side: "top", align: 'start' } },
                        { element: '#help-btn', popover: { title: 'Selesai!', description: 'Jika butuh bantuan lagi, klik saja tombol ini untuk mengulang panduan. Selamat belajar!' } }
                    ],
                    onCloseClick: () => {
                        driverObj.destroy();
                        appState.guideCompleted = true;
                        localStorage.setItem('edunify_guide_completed_v2', 'true');
                        showToast('info', 'Panduan dilewati. Kamu bisa memulainya lagi dari tombol bantuan.');
                    },
                    onDestroyed: () => {
                        appState.guideCompleted = true;
                        localStorage.setItem('edunify_guide_completed_v2', 'true');
                    }
                });

                // Switch to chat view for the first step if not already there
                if (appState.currentToolId !== 'ai-chat') {
                    selectTool('ai-chat', true);
                    setTimeout(() => driverObj.drive(), 300); // wait for view to render
                } else {
                    driverObj.drive();
                }
            }

            function toggleFullScreen() {
                const i = DOMElements.fullscreenBtn.querySelector('i');
                if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); i.className = 'fas fa-compress'; } 
                else if (document.exitFullscreen) { document.exitFullscreen(); i.className = 'fas fa-expand'; }
            }

            function showModal(el) { el.classList.add('flex'); el.classList.remove('hidden'); }
            function hideModal(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
            function updateSendButtonsState() {
                document.querySelectorAll('.send-chat-btn,.generic-submit-btn').forEach(b => {
                    if (!b) return;
                    b.disabled = appState.isGenerating;
                    const icon = b.querySelector('i');
                    if(icon) {
                        icon.classList.toggle('fa-spin', appState.isGenerating);
                        icon.classList.toggle('fa-paper-plane', !appState.isGenerating && b.classList.contains('send-chat-btn'));
                        icon.classList.toggle('fa-cogs', !appState.isGenerating && b.classList.contains('generic-submit-btn'));
                    }
                });
            }
            function showToast(type, message) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const i = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');
                toast.innerHTML = `<i class="fas ${i} text-2xl"></i><p>${message}</p>`;
                DOMElements.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            init();
        });
    </script>
</body>
</html>
